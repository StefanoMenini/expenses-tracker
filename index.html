<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Expense Tracker</title>
    <style>
        :root {
            --bg-body: #0a0a0a;
            --bg-card: #1c1c1e;
            --bg-input: #2c2c2e;
            --primary: #5e5ce6;
            --primary-glow: rgba(94, 92, 230, 0.3);
            --danger: #ff453a;
            --success: #32d74b;
            --text-main: #ffffff;
            --text-muted: #8e8e93;
            --border: #333;
            --border-radius: 16px;
            --pad: 20px;
        }

        /* Light Theme Override */
        [data-theme="light"] {
            --bg-body: #f2f2f7;
            --bg-card: #ffffff;
            --bg-input: #e5e5ea;
            --text-main: #000000;
            --text-muted: #8e8e93;
            --primary: #007aff;
            --primary-glow: rgba(0, 122, 255, 0.3);
            --danger: #ff3b30;
            --success: #34c759;
            --border: #c6c6c8;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Views */
        .view-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: var(--pad);
            padding-bottom: 80px;
            /* Space for navbar */
            overflow-y: auto;
            opacity: 0;
            transform: translateY(10px);
            pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .view.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
            z-index: 1;
        }

        h1 {
            margin: 0 0 20px 0;
            font-size: 28px;
            letter-spacing: -0.5px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: var(--text-muted);
            margin-bottom: 8px;
            font-size: 14px;
        }

        input,
        select,
        textarea {
            width: 100%;
            background: var(--bg-input);
            border: none;
            color: var(--text-main);
            padding: 16px;
            border-radius: 12px;
            font-size: 16px;
            outline: none;
            transition: box-shadow 0.2s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            box-shadow: 0 0 0 2px var(--primary);
        }

        button.primary-btn {
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            padding: 18px;
            border-radius: var(--border-radius);
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 20px var(--primary-glow);
            transition: transform 0.1s;
        }

        select {
            width: 100%;
            background: var(--bg-input);
            border: none;
            color: var(--text-main);
            padding: 16px;
            border-radius: 12px;
            font-size: 17px;
            box-sizing: border-box;
            appearance: none;
        }

        /* Buttons */
        .primary-btn {
            background: var(--primary);
            color: white;
            border: none;
            width: 100%;
            padding: 16px;
            border-radius: 14px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        /* Recap Styles ... */
        .summary-card {
            background: var(--bg-card);
            margin: 0 20px 20px;
            padding: 24px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .summary-label {
            color: var(--text-muted);
            font-size: 14px;
            margin-bottom: 5px;
        }

        .summary-total {
            font-size: 36px;
            font-weight: 700;
            color: var(--text-main);
        }

        .cat-breakdown {
            padding: 0 20px;
        }

        .cat-item {
            margin-bottom: 12px;
        }

        .cat-header {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            margin-bottom: 6px;
        }

        .cat-bar-bg {
            background: var(--bg-input);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }

        .cat-bar-fill {
            background: var(--primary);
            height: 100%;
            border-radius: 4px;
        }

        .expense-list {
            padding: 0 20px;
        }

        .expense-item {
            background: var(--bg-card);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .expense-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .expense-cat {
            font-weight: 600;
            font-size: 16px;
        }

        .expense-date {
            color: var(--text-muted);
            font-size: 13px;
        }

        .expense-amount {
            font-weight: 600;
            font-size: 16px;
        }

        /* Date Nav */
        .date-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            gap: 12px;
        }

        .nav-btn {
            background: var(--bg-input);
            border: none;
            color: var(--text-main);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            /* Fix for arrow centering */
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
        }

        .nav-title {
            font-size: 17px;
            font-weight: 600;
            min-width: 140px;
            text-align: center;
            cursor: pointer;
            /* Interaction hint */
            padding: 4px 8px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .nav-title:active {
            background: var(--bg-input);
        }

        .tab-bar {
            background: rgba(28, 28, 30, 0.95);

            /* Support light mode backdrop */
            [data-theme="light"] & {
                background: rgba(240, 240, 240, 0.95);
            }

            backdrop-filter: blur(10px);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
            position: fixed;
            bottom: 0;
            width: 100%;
            z-index: 100;
        }

        .tab-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
        }

        .tab-btn.active {
            color: var(--primary);
        }

        .tab-btn svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        /* Modal for Date Picking */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            /* lighter overlay */
            backdrop-filter: blur(5px);
            z-index: 200;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background: var(--bg-card);
            padding: 24px;
            border-radius: 20px;
            width: 85%;
            max-width: 320px;
            border: 1px solid var(--border);
            transform: scale(0.95);
            transition: transform 0.2s;
            display: flex;
            flex-direction: column;
            max-height: 80vh;
            color: var(--text-main);
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        .modal-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
            max-height: 50vh;
            /* Scrollable area */
            padding-right: 4px;
            /* Space for scrollbar */
        }

        /* CustomScrollbar */
        .modal-list::-webkit-scrollbar {
            width: 4px;
        }

        .modal-list::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        .modal-item {
            background: var(--bg-input);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s;
            flex-shrink: 0;
            font-weight: 500;
            color: var(--text-main);
        }

        .modal-item.active {
            background: var(--primary);
            color: white;
        }

        .modal-title {
            text-align: center;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
            flex-shrink: 0;
        }

        /* Settings View Styles */
        .settings-section {
            background: var(--bg-card);
            margin: 0 20px 20px;
            border-radius: 12px;
            overflow: hidden;
        }

        .cat-manage-list {
            padding: 0;
        }

        .cat-manage-item {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cat-manage-item:last-child {
            border-bottom: none;
        }

        .delete-btn {
            background: var(--danger);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            font-size: 18px;
            line-height: 1;
            /* Center X */
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-cat-form {
            display: flex;
            gap: 10px;
            margin: 0 20px;
        }

        .add-cat-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <div class="view-container">
        <!-- ADD EXPENSE VIEW -->
        <div id="view-add" class="view active">
            <h1>New Expense</h1>
            <form id="add-form">
                <div class="form-group" style="display:flex; gap:10px;">
                    <div style="flex:1;">
                        <label>Amount</label>
                        <input type="number" id="amount" placeholder="0.00" step="0.01" inputmode="decimal" required
                            style="font-size: 24px;">
                    </div>
                    <div style="width:100px;">
                        <label>Currency</label>
                        <select id="expense-currency" style="font-size: 18px; font-weight:600; padding:16px 8px;">
                            <option value="EUR">EUR</option>
                            <option value="USD">USD</option>
                            <option value="GBP">GBP</option>
                            <option value="JPY">JPY</option>
                            <option value="CAD">CAD</option>
                            <option value="AUD">AUD</option>
                            <option value="INR">INR</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Category</label>
                    <select id="category" required>
                        <!-- Dynamic Categories -->
                    </select>
                </div>

                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="date" required>
                </div>

                <div class="form-group">
                    <label>Note (Optional)</label>
                    <input type="text" id="note" placeholder="What was it for?">
                </div>

                <button type="submit" class="primary-btn">Save Expense</button>
            </form>
        </div>

        <!-- RECAP VIEW -->
        <div id="view-recap" class="view">
            <h1>Recap</h1>

            <div class="date-nav">
                <button class="nav-btn" onclick="changePeriod(-1)">&#9664;</button>
                <div id="nav-title" class="nav-title" onclick="toggleViewMode()"></div>
                <button class="nav-btn" onclick="changePeriod(1)">&#9654;</button>
            </div>

            <div class="summary-card">
                <div class="summary-label">Total Spent</div>
                <div class="summary-total" id="total-display">$0.00</div>
            </div>

            <h3>Breakdown</h3>
            <div id="cat-breakdown" class="cat-breakdown">
                <!-- Bars injected here -->
            </div>

            <h3>History</h3>
            <div id="history-list" class="expense-list">
                <!-- Items injected here -->
            </div>
        </div>

        <!-- SETTINGS VIEW -->
        <div id="view-settings" class="view">
            <h1>Settings</h1>

            <h3>Appearance</h3>
            <div class="settings-section">
                <div class="form-group" style="margin:0; padding:10px;">
                    <select id="theme-select" onchange="updateTheme()">
                        <option value="system">‚öôÔ∏è System Default</option>
                        <option value="dark">üåô Dark Mode</option>
                        <option value="light">‚òÄÔ∏è Light Mode</option>
                    </select>
                </div>
            </div>


            <h3>Currency</h3>
            <div class="settings-section">
                <div class="form-group" style="margin:0; padding:10px;">
                    <select id="currency-select" onchange="updateCurrency()">
                        <option value="EUR">EUR (‚Ç¨)</option>
                        <option value="USD">USD ($)</option>
                        <option value="GBP">GBP (¬£)</option>
                        <option value="JPY">JPY (¬•)</option>
                        <option value="CAD">CAD ($)</option>
                        <option value="AUD">AUD ($)</option>
                        <option value="INR">INR (‚Çπ)</option>
                    </select>
                </div>
            </div>
            <h3>Categories</h3>
            <div id="cat-manage-list" class="settings-section cat-manage-list">
                <!-- Injected via JS -->
            </div>

            <div class="add-cat-form">
                <input type="text" id="new-cat-name" placeholder="New Category Name">
                <button class="add-cat-btn" onclick="addCategory()">Add</button>
            </div>
            <!-- DATA MANAGEMENT REMOVED -->

            <h3>Google Cloud Sync</h3>
            <div class="settings-section">
                <div style="padding:20px; text-align:center;">
                    <div id="google-status" style="margin-bottom:15px; color:var(--text-muted);">Not connected</div>
                    <button id="google-connect-btn" onclick="handleGoogleAuth()"
                        style="width:100%; padding:12px; background:#4285F4; color:white; border:none; border-radius:12px; font-weight:600; font-size:16px;">
                        Link Google Account
                    </button>
                    <button id="google-sync-btn" onclick="exportToGoogleSheet()"
                        style="display:none; width:100%; padding:12px; background:#34A853; color:white; border:none; border-radius:12px; font-weight:600; font-size:16px;">
                        Sync to Sheets
                    </button>
                    <div style="margin-top:10px; font-size:12px; color:var(--text-muted);">
                        Requires active internet connection and valid Client ID.
                    </div>
                </div>
            </div>

            <div style="height: 40px;"></div>
        </div>
    </div>

    <!-- DATE PICKER MODAL -->
    <div id="date-modal" class="modal-overlay" onclick="hideModal(event)">
        <div class="modal-content">
            <div id="modal-title" class="modal-title">Select</div>
            <div id="modal-list" class="modal-list"></div>
        </div>
    </div>

    <!-- TAB BAR -->
    <nav class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('add')">
            <svg viewBox="0 0 24 24">
                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
            </svg>
            Add
        </button>
        <button class="tab-btn" onclick="switchTab('recap')">
            <svg viewBox="0 0 24 24">
                <path
                    d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z" />
            </svg>
            Recap
        </button>
        <button class="tab-btn" onclick="switchTab('settings')">
            <svg viewBox="0 0 24 24">
                <path
                    d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.57 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z" />
            </svg>
            Settings
        </button>
    </nav>

    <!-- CONFIRM MODAL -->
    <div id="confirm-modal" class="modal-overlay" style="z-index: 2000;">
        <div class="modal-content" style="height:auto; min-height:auto; padding:20px;">
            <div class="modal-title" style="margin-bottom:10px;">Delete Expense?</div>
            <div style="text-align:center; color:var(--text-muted); margin-bottom:20px;">
                This action cannot be undone.
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="closeConfirmModal()"
                    style="flex:1; padding:12px; background:var(--bg-input); color:var(--text-main); border:none; border-radius:12px; font-weight:600; font-size:16px;">Cancel</button>
                <button onclick="executeAction()"
                    style="flex:1; padding:12px; background:var(--danger); color:white; border:none; border-radius:12px; font-weight:600; font-size:16px;">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // State
        let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
        // Default Settings
        const defaultSettings = {
            currency: 'EUR',
            theme: 'dark', // 'light', 'dark', 'system'
            categories: ["üçî Food", "üöå Transport", "üõçÔ∏è Shopping", "üé¨ Entertainment", "üßæ Bills", "üíä Health", "üîπ Other"]
        };
        let settings = JSON.parse(localStorage.getItem('settings')) || defaultSettings;

        // Static Exchange Rates (Base: EUR) - Approximate
        const EXCHANGE_RATES = {
            'EUR': 1.00,
            'USD': 1.09,
            'GBP': 0.86,
            'JPY': 163.0,
            'CAD': 1.48,
            'AUD': 1.65,
            'INR': 90.0
        };

        let currentDate = new Date();
        let viewMode = 'month'; // 'month' or 'year'

        // Pagination State
        let displayLimit = 50;
        const LIMIT_STEP = 50;

        // Elements
        const form = document.getElementById('add-form');
        const amountInput = document.getElementById('amount');
        const currencyInput = document.getElementById('expense-currency');
        const catInput = document.getElementById('category');
        const dateInput = document.getElementById('date');
        const noteInput = document.getElementById('note');

        const totalDisplay = document.getElementById('total-display');
        const historyList = document.getElementById('history-list');
        const catBreakdown = document.getElementById('cat-breakdown');
        const navTitle = document.getElementById('nav-title');
        const viewRecap = document.getElementById('view-recap');

        const modal = document.getElementById('date-modal');
        const modalList = document.getElementById('modal-list');
        const modalTitle = document.getElementById('modal-title');

        const confirmModal = document.getElementById('confirm-modal');

        const themeSelect = document.getElementById('theme-select');
        const currencySelect = document.getElementById('currency-select');
        const catManageList = document.getElementById('cat-manage-list');
        const newCatName = document.getElementById('new-cat-name');

        // Init
        document.getElementById('date').valueAsDate = new Date();
        initSettings();

        // ... (Settings & Theme Logic Unchanged) ...
        function initSettings() {
            if (!settings.categories || settings.categories.length === 0) settings.categories = defaultSettings.categories;
            themeSelect.value = settings.theme;
            currencySelect.value = settings.currency;
            if (currencyInput) currencyInput.value = settings.currency;
            applyTheme();
            renderCategoryOptions();
            renderManageCategories();
        }
        function saveSettings() { localStorage.setItem('settings', JSON.stringify(settings)); }
        function convertAmount(amount, fromCurrency, toCurrency) {
            if (fromCurrency === toCurrency) return amount;
            const amountInUSD = amount / (EXCHANGE_RATES[fromCurrency] || 1);
            return amountInUSD * (EXCHANGE_RATES[toCurrency] || 1);
        }
        function getCurrencySymbol(code) {
            return (0).toLocaleString('en-US', { style: 'currency', currency: code, minimumFractionDigits: 0, maximumFractionDigits: 0 }).replace(/\d/g, '').trim();
        }
        function formatCurrency(num, code = settings.currency) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: code }).format(num);
        }
        function updateTheme() { settings.theme = themeSelect.value; saveSettings(); applyTheme(); }
        function applyTheme() {
            document.body.removeAttribute('data-theme');
            let targetTheme = settings.theme;
            if (targetTheme === 'system') {
                const isLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
                targetTheme = isLight ? 'light' : 'dark';
            }
            document.body.setAttribute('data-theme', targetTheme);
        }
        function updateCurrency() { settings.currency = currencySelect.value; saveSettings(); if (currencyInput) currencyInput.value = settings.currency; renderRecap(); }
        function renderCategoryOptions() {
            catInput.innerHTML = '';
            settings.categories.forEach(cat => { const opt = document.createElement('option'); opt.value = cat; opt.textContent = cat; catInput.appendChild(opt); });
        }
        function renderManageCategories() {
            catManageList.innerHTML = '';
            settings.categories.forEach((cat, index) => {
                const el = document.createElement('div');
                el.className = 'cat-manage-item';
                el.innerHTML = `<span>${cat}</span><button class="delete-btn" onclick="removeCategory(${index})">√ó</button>`;
                catManageList.appendChild(el);
            });
        }
        function addCategory() {
            const val = newCatName.value.trim();
            if (val && !settings.categories.includes(val)) { settings.categories.push(val); saveSettings(); renderCategoryOptions(); renderManageCategories(); newCatName.value = ''; }
        }
        function removeCategory(index) {
            showConfirmModal('category', index, settings.categories[index]);
        }

        // --- Google Sync Logic ---
        const GOOGLE_CLIENT_ID = 'YOUR_CLIENT_ID_HERE'; // User must provide this if hosting
        const GOOGLE_SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file';
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        function checkGoogleReady() {
            // Optional: Auto-login check if needed
            if (gapiInited && gisInited && settings.googleUserInfo) {
                updateGoogleUI(true);
            }
        }

        function gapiLoaded() {
            gapi.load('client', async () => {
                await gapi.client.init({
                    // apiKey: 'YOUR_API_KEY', // Optional
                    discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
                });
                gapiInited = true;
                checkGoogleReady();
            });
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: GOOGLE_SCOPES,
                callback: '', // defined at request time
            });
            gisInited = true;
            checkGoogleReady();
        }

        function handleGoogleAuth() {
            // Check Protocol FIRST (Most common issue for local users)
            if (window.location.protocol === 'file:') {
                alert("‚ö†Ô∏è Google Login requires a web server (https://...).\nIt does NOT work from a local file (file://).\n\nDetails: Google's security blocks 'file://' origins from loading its scripts or signing in.\n\nSolution: Host this app on GitHub Pages, Vercel, or a local server.");
                return;
            }

            if (!gapiInited || !gisInited) {
                alert("‚ö†Ô∏è Google Services not ready.\nPlease check your internet connection and try again.");
                // Try reloading scripts if missing?
                if (!document.querySelector('script[src*="apis.google.com"]')) {
                    const s1 = document.createElement('script'); s1.src = "https://apis.google.com/js/api.js"; s1.onload = gapiLoaded; document.body.appendChild(s1);
                    const s2 = document.createElement('script'); s2.src = "https://accounts.google.com/gsi/client"; s2.onload = gisLoaded; document.body.appendChild(s2);
                }
                return;
            }
            if (GOOGLE_CLIENT_ID === 'YOUR_CLIENT_ID_HERE') {
                const id = prompt("Please enter your Google Cloud Client ID to enable Sync:");
                if (id) {
                    // Temporarily override for session
                    tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: id,
                        scope: GOOGLE_SCOPES,
                        callback: '',
                    });
                } else {
                    return;
                }
            }

            tokenClient.callback = async (resp) => {
                if (resp.error) {
                    throw resp;
                }
                // Success
                await fetchGoogleProfile(resp.access_token);
                updateGoogleUI(true);
                // Auto-sync after login?
                // exportToGoogleSheet(); 
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                tokenClient.requestAccessToken({ prompt: '' });
            }
        }

        async function fetchGoogleProfile(token) {
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                    headers: { Authorization: `Bearer ${token}` }
                });
                const info = await response.json();
                settings.googleUserInfo = info;
                saveSettings();
            } catch (err) {
                console.error("Profile fetch error", err);
            }
        }

        async function exportToGoogleSheet() {
            if (!settings.googleUserInfo) { handleGoogleAuth(); return; }

            const btn = document.getElementById('google-sync-btn');
            const originalText = btn.textContent;
            btn.textContent = 'Syncing...';
            btn.disabled = true;

            try {
                // Ensure we have a valid token
                // In a real app, we'd check expiry. Here access_token is in gapi.client
                // 1. Create Folder (Optional, skipping for simplicity, root of Drive)
                // 2. Create Sheet
                const title = `Expense Tracker Backup ${new Date().toISOString().slice(0, 10)}`;
                const createResp = await gapi.client.sheets.spreadsheets.create({
                    properties: { title: title }
                });
                const spreadsheetId = createResp.result.spreadsheetId;

                // 3. Prepare Data
                const headers = ["Date", "Category", "Note", "Amount", "Currency", "Converted Amount", "Main Currency"];
                const rows = expenses.map(e => {
                    const converted = convertAmount(e.amount, e.currency || settings.currency, settings.currency);
                    return [
                        e.date,
                        e.category,
                        e.note || "",
                        e.amount,
                        e.currency || settings.currency,
                        converted.toFixed(2),
                        settings.currency
                    ];
                });
                const values = [headers, ...rows];

                // 4. Write Data
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: spreadsheetId,
                    range: 'Sheet1!A1',
                    valueInputOption: 'USER_ENTERED',
                    resource: { values: values }
                });

                alert(`Success! Saved to "${title}" in your Google Drive.`);
            } catch (err) {
                console.error("Sync Error", err);
                alert("Sync failed. See console for details.");
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        function updateGoogleUI(isConnected) {
            const connectBtn = document.getElementById('google-connect-btn');
            const syncBtn = document.getElementById('google-sync-btn');
            const statusText = document.getElementById('google-status');

            if (isConnected && settings.googleUserInfo) {
                connectBtn.style.display = 'none';
                syncBtn.style.display = 'block';
                statusText.innerHTML = `Connected as <b>${settings.googleUserInfo.name}</b>`;
                statusText.style.color = '#32d74b';
            } else {
                connectBtn.style.display = 'block';
                syncBtn.style.display = 'none';
                statusText.textContent = 'Not connected';
                statusText.style.color = 'var(--text-muted)';
            }
        }

        // Load scripts if online
        if (navigator.onLine) {
            const s1 = document.createElement('script'); s1.src = "https://apis.google.com/js/api.js"; s1.onload = gapiLoaded; document.body.appendChild(s1);
            const s2 = document.createElement('script'); s2.src = "https://accounts.google.com/gsi/client"; s2.onload = gisLoaded; document.body.appendChild(s2);
        }

        // --- Swipe, Long Press (Unchanged) ---
        let touchStartX = 0;
        let touchEndX = 0;
        viewRecap.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, false);
        viewRecap.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, false);
        function handleSwipe() {
            const threshold = 50;
            if (touchEndX < touchStartX - threshold) changePeriod(1);
            if (touchEndX > touchStartX + threshold) changePeriod(-1);
        }
        let longPressTimer;
        function startPress(e) { longPressTimer = setTimeout(() => { showModal(); }, 500); }
        function cancelPress() { clearTimeout(longPressTimer); }
        navTitle.addEventListener('touchstart', startPress);
        navTitle.addEventListener('touchend', cancelPress);
        navTitle.addEventListener('mousedown', startPress);
        navTitle.addEventListener('mouseup', cancelPress);
        navTitle.addEventListener('mouseleave', cancelPress);
        navTitle.onclick = (e) => { if (window.didLongPress || modal.classList.contains('active')) return; toggleViewMode(); };

        function toggleViewMode() {
            if (window.didLongPress) { window.didLongPress = false; return; }
            viewMode = viewMode === 'month' ? 'year' : 'month';
            displayLimit = LIMIT_STEP; // Reset pagination
            renderRecap();
        }

        function showModal() {
            window.didLongPress = true; modal.classList.add('active'); modalList.innerHTML = '';
            if (viewMode === 'month') {
                modalTitle.textContent = "Jump to Month";
                const now = new Date();
                const start = new Date(currentDate); start.setMonth(start.getMonth() + 6);
                let minYear = now.getFullYear();
                if (expenses.length > 0) minYear = Math.min(...expenses.map(e => new Date(e.date).getFullYear()));
                const minDate = new Date(minYear, 0, 1);
                const cursor = new Date(start);
                let limit = 200;
                while (cursor >= minDate && limit > 0) {
                    const y = cursor.getFullYear();
                    const m = cursor.getMonth();
                    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                    const el = document.createElement('div');
                    const isActive = (y === currentDate.getFullYear() && m === currentDate.getMonth());
                    el.className = 'modal-item ' + (isActive ? 'active' : '');
                    el.textContent = `${monthNames[m]} ${y}`;
                    const targetData = { year: y, month: m };
                    el.onclick = () => selectPeriod(targetData);
                    modalList.appendChild(el);
                    cursor.setMonth(cursor.getMonth() - 1);
                    limit--;
                }
            } else {
                modalTitle.textContent = "Jump to Year";
                let maxYear = new Date().getFullYear() + 1;
                let minYear = maxYear - 5;
                if (expenses.length > 0) {
                    const expenseYears = expenses.map(e => new Date(e.date).getFullYear());
                    maxYear = Math.max(maxYear, ...expenseYears);
                    minYear = Math.min(minYear, ...expenseYears);
                }
                for (let y = maxYear; y >= minYear; y--) {
                    const el = document.createElement('div');
                    el.className = 'modal-item ' + (currentDate.getFullYear() === y ? 'active' : '');
                    el.textContent = y;
                    el.onclick = () => selectPeriod({ year: y });
                    modalList.appendChild(el);
                }
            }
            setTimeout(() => { const active = modalList.querySelector('.active'); if (active) active.scrollIntoView({ block: "center" }); }, 10);
        }

        function hideModal(e) { if (e.target === modal) { modal.classList.remove('active'); window.didLongPress = false; } }
        function selectPeriod(data) {
            if (viewMode === 'month') { currentDate.setFullYear(data.year); currentDate.setMonth(data.month); } else { currentDate.setFullYear(data.year); }
            displayLimit = LIMIT_STEP; // Reset
            renderRecap(); modal.classList.remove('active'); window.didLongPress = false;
        }
        function changePeriod(offset) {
            if (viewMode === 'month') { currentDate.setMonth(currentDate.getMonth() + offset); } else { currentDate.setFullYear(currentDate.getFullYear() + offset); }
            displayLimit = LIMIT_STEP; // Reset
            renderRecap();
        }

        function saveExpenses() {
            localStorage.setItem('expenses', JSON.stringify(expenses));
            renderRecap();
        }

        function addExpense(e) {
            e.preventDefault();
            const expense = { id: Date.now(), amount: parseFloat(amountInput.value), currency: currencyInput ? currencyInput.value : settings.currency, category: catInput.value, date: dateInput.value, note: noteInput.value };
            expenses.unshift(expense); saveExpenses();
            amountInput.value = ''; noteInput.value = ''; dateInput.valueAsDate = new Date();
            const btn = form.querySelector('button'); const originalText = btn.textContent; btn.textContent = 'Saved!'; btn.style.background = '#32d74b';
            setTimeout(() => { btn.textContent = originalText; btn.style.background = ''; }, 1500);
        }

        // --- Custom Confirm Logic (Generic) ---
        let pendingAction = null; // { type: 'expense'|'category'|'restore', id: ... }

        function showConfirmModal(type, id, name = '') {
            if (event) event.stopPropagation();
            pendingAction = { type, id };

            const titleEl = document.querySelector('#confirm-modal .modal-title');
            const bodyEl = document.querySelector('#confirm-modal > .modal-content > div:nth-child(2)');
            const confirmBtn = document.querySelector('#confirm-modal button:last-child');

            // Defaults
            confirmBtn.textContent = 'Delete';
            confirmBtn.style.background = 'var(--danger)';

            if (type === 'expense') {
                titleEl.textContent = "Delete Expense?";
                bodyEl.textContent = "This action cannot be undone.";
            } else if (type === 'category') {
                titleEl.textContent = "Delete Category?";
                bodyEl.textContent = `Delete "${name}" and remove it from list?`;
            } else if (type === 'restore') {
                titleEl.textContent = "Restore Data?";
                bodyEl.textContent = "This will OVERWRITE all current data with the backup file.";
                confirmBtn.textContent = 'Restore';
                confirmBtn.style.background = 'var(--primary)';
            }

            confirmModal.classList.add('active');
        }

        function closeConfirmModal() {
            confirmModal.classList.remove('active');
            pendingAction = null;
            window.pendingImportData = null; // Clear temp data
        }

        function executeAction() { // Renamed from executeDelete
            if (!pendingAction) return;

            if (pendingAction.type === 'expense') {
                expenses = expenses.filter(e => e.id !== pendingAction.id);
                saveExpenses();
            } else if (pendingAction.type === 'category') {
                settings.categories.splice(pendingAction.id, 1);
                saveSettings();
                renderCategoryOptions();
                renderManageCategories();
            } else if (pendingAction.type === 'restore') {
                // Restore Logic
                if (window.pendingImportData) {
                    expenses = window.pendingImportData.expenses || [];
                    if (window.pendingImportData.settings) {
                        settings = window.pendingImportData.settings;
                        saveSettings();
                    }
                    saveExpenses(); // Will save expenses and render
                    initSettings(); // Apply restored settings
                    alert("Data restored successfully!");
                }
            }

            closeConfirmModal();
        }

        // Modal overlay click
        confirmModal.onclick = (e) => { if (e.target === confirmModal) closeConfirmModal(); };

        // --- Render Recap (Pagination) ---
        function renderRecap() {
            const year = currentDate.getFullYear();
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            navTitle.textContent = (viewMode === 'month') ? `${monthNames[currentDate.getMonth()]} ${year}` : `${year}`;

            const filtered = expenses.filter(item => { const d = new Date(item.date); const yearMatch = d.getFullYear() === year; if (viewMode === 'year') return yearMatch; return yearMatch && d.getMonth() === currentDate.getMonth(); });

            // Total (All filtered)
            const total = filtered.reduce((sum, item) => sum + convertAmount(item.amount, item.currency || settings.currency, settings.currency), 0);
            totalDisplay.textContent = formatCurrency(total, settings.currency);

            // Categories (All filtered)
            const cats = {};
            filtered.forEach(item => { const val = convertAmount(item.amount, item.currency || settings.currency, settings.currency); cats[item.category] = (cats[item.category] || 0) + val; });
            const sortedCats = Object.entries(cats).sort((a, b) => b[1] - a[1]);
            catBreakdown.innerHTML = '';
            if (sortedCats.length === 0) { catBreakdown.innerHTML = '<div style="color:var(--text-muted); text-align:center; font-size:14px;">No data for period</div>'; }
            else { const maxVal = sortedCats[0][1]; sortedCats.forEach(([name, val]) => { const percent = (val / total) * 100; const barWidth = (val / maxVal) * 100; const el = document.createElement('div'); el.className = 'cat-item'; el.innerHTML = `<div class="cat-header"><span>${name}</span><span>${formatCurrency(val, settings.currency)} (${Math.round(percent)}%)</span></div><div class="cat-bar-bg"><div class="cat-bar-fill" style="width: ${barWidth}%"></div></div>`; catBreakdown.appendChild(el); }); }

            // History (Paginated)
            historyList.innerHTML = '';
            if (filtered.length === 0) { historyList.innerHTML = '<div class="empty-state">No expenses found</div>'; return; }

            const itemsToShow = filtered.slice(0, displayLimit);

            itemsToShow.forEach(item => {
                const itemCurrency = item.currency || settings.currency;
                const converted = convertAmount(item.amount, itemCurrency, settings.currency);
                const isDifferent = itemCurrency !== settings.currency;
                const el = document.createElement('div'); el.className = 'expense-item';
                let amountHtml = `<div class="expense-amount">${formatCurrency(converted, settings.currency)}</div>`;
                if (isDifferent) { amountHtml += `<div style="font-size:12px; color:var(--text-muted); text-align:right;">${formatCurrency(item.amount, itemCurrency)}</div>`; }
                el.innerHTML = `
                    <div class="expense-info"><span class="expense-cat">${item.category}</span><span class="expense-date">${item.date} ${item.note ? '‚Ä¢ ' + item.note : ''}</span></div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div>${amountHtml}</div>
                        <button onclick="showConfirmModal('expense', ${item.id})" ontouchstart="event.stopPropagation()" ontouchend="event.stopPropagation()" style="background:none; border:none; color:var(--text-muted); font-size:20px; padding:0 5px; cursor:pointer;" >√ó</button>
                    </div>
                `;
                historyList.appendChild(el);
            });

            // Show More Button
            if (filtered.length > displayLimit) {
                const showMoreBtn = document.createElement('button');
                showMoreBtn.textContent = `Show More (${filtered.length - displayLimit} more)`;
                showMoreBtn.style.cssText = "width:100%; padding:15px; background:var(--bg-input); color:var(--primary); border:none; border-radius:12px; font-weight:600; margin-top:10px; cursor:pointer;";
                showMoreBtn.onclick = () => {
                    displayLimit += LIMIT_STEP;
                    renderRecap();
                };
                historyList.appendChild(showMoreBtn);
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            let idx = 0; if (tabName === 'recap') idx = 1; if (tabName === 'settings') idx = 2;
            document.querySelectorAll('.tab-btn')[idx].classList.add('active');
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(`view-${tabName}`).classList.add('active');
            if (tabName === 'recap') {
                displayLimit = LIMIT_STEP; // Reset
                renderRecap();
            }
        }

        form.addEventListener('submit', addExpense);
        renderRecap();
    </script>
</body>

</html>